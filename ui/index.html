<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>xopcbot UI</title>
  <script type="module" src="./src/index.ts"></script>
  <link rel="stylesheet" href="./src/styles.css">
  <style>
    /* Prevent flash of unstyled content - default to light theme */
    html { background: #fafaf9; }
    html.dark { background: #0c0a09; }
    @media (prefers-color-scheme: dark) {
      html:not(.light) { background: #0c0a09; }
    }
  </style>
</head>
<body class="h-screen">
  <div id="app" class="h-full">
    <xopcbot-app id="app-root"></xopcbot-app>
  </div>

  <script>
    // Initialize the app with gateway config
    document.addEventListener('DOMContentLoaded', () => {
      const app = document.getElementById('app-root');
      if (app) {
        // Get gateway URL from current location or use default
        // For dev (port 3000), default to 18790. For prod, use same port.
        const urlParams = new URLSearchParams(window.location.search);
        const currentHost = window.location.hostname || 'localhost';
        const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
        // Default to 18790 (gateway port), but respect ?gateway= param
        const defaultPort = currentPort === '3000' ? '18790' : currentPort;
        const gatewayUrl = urlParams.get('gateway') || `${window.location.protocol}//${currentHost}:${defaultPort}`;
        
        // Get token from URL if provided
        const token = urlParams.get('token') || undefined;

        app.gatewayConfig = {
          url: gatewayUrl,
          token: token
        };

        // Default settings sections
        app.settingsSections = [
          {
            id: 'connection',
            title: 'Connection',
            icon: 'plug',
            fields: [
              {
                key: 'gatewayUrl',
                label: 'Gateway URL',
                type: 'text',
                description: 'HTTP URL for the gateway server',
                placeholder: 'http://localhost:18790'
              },
              {
                key: 'token',
                label: 'Auth Token',
                type: 'password',
                description: 'Optional authentication token'
              }
            ]
          },
          {
            id: 'appearance',
            title: 'Appearance',
            icon: 'palette',
            fields: [
              {
                key: 'theme',
                label: 'Theme',
                type: 'select',
                description: 'Choose your preferred color scheme',
                options: [
                  { value: 'system', label: 'System' },
                  { value: 'light', label: 'Light' },
                  { value: 'dark', label: 'Dark' }
                ]
              }
            ]
          },
          {
            id: 'chat',
            title: 'Chat',
            icon: 'messageSquare',
            fields: [
              {
                key: 'enableAttachments',
                label: 'Enable Attachments',
                type: 'boolean',
                description: 'Allow file attachments in chat'
              },
              {
                key: 'enableModelSelector',
                label: 'Show Model Selector',
                type: 'boolean',
                description: 'Display model selection dropdown'
              },
              {
                key: 'enableThinkingSelector',
                label: 'Show Thinking Selector',
                type: 'boolean',
                description: 'Display thinking level selection'
              }
            ]
          }
        ];

        // Default settings values
        app.settingsValues = {
          gatewayUrl: gatewayUrl,
          token: token,
          theme: 'system',
          enableAttachments: true,
          enableModelSelector: true,
          enableThinkingSelector: true
        };

        // Handle settings save
        app.onSettingsSave = (values) => {
          console.log('Settings saved:', values);
          
          // Update gateway config if changed
          if (values.gatewayUrl && values.gatewayUrl !== app.gatewayConfig?.url) {
            app.gatewayConfig = {
              url: values.gatewayUrl,
              token: values.token
            };
          }
          
          // Save to localStorage (but don't store gatewayUrl/token for security)
          const safeValues = { ...values };
          delete safeValues.gatewayUrl;
          delete safeValues.token;
          localStorage.setItem('xopcbot-settings', JSON.stringify(safeValues));
        };

        // Load saved settings (but ignore old gateway URLs to avoid port issues)
        const savedSettings = localStorage.getItem('xopcbot-settings');
        if (savedSettings) {
          try {
            const parsed = JSON.parse(savedSettings);
            // Only apply non-connection settings from localStorage
            const { gatewayUrl, token, ...otherSettings } = parsed;
            Object.assign(app.settingsValues, otherSettings);
          } catch (e) {
            console.error('Failed to load saved settings:', e);
          }
        }

        // Add keyboard shortcut to open settings
        document.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === ',') {
            e.preventDefault();
            app.showSettings();
          }
        });

        // Expose app to window for debugging
        window.xopcbotApp = app;
      }
    });
  </script>
</body>
</html>
